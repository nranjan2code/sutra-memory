name: Dependency Security Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  python-security:
    name: Python Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install pip-audit
        run: pip install pip-audit
      
      - name: Run pip-audit
        run: |
          # Scan each Python package
          for req_file in $(find . -name "requirements*.txt" -o -name "pyproject.toml" | grep -v node_modules); do
            echo "Scanning $req_file"
            if [[ $req_file == *.txt ]]; then
              pip-audit -r "$req_file" --format json --output "$(basename $req_file .txt)-audit.json" || true
            fi
          done
      
      - name: Upload Python vulnerability reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: python-vulnerability-reports
          path: '*-audit.json'
      
      - name: Check for critical vulnerabilities
        run: |
          critical_count=0
          for audit_file in *-audit.json; do
            if [ -f "$audit_file" ]; then
              critical=$(jq '[.vulnerabilities[] | select(.severity == "CRITICAL")] | length' "$audit_file")
              critical_count=$((critical_count + critical))
            fi
          done
          if [ $critical_count -gt 0 ]; then
            echo "❌ Found $critical_count CRITICAL vulnerabilities"
            exit 1
          else
            echo "✅ No critical vulnerabilities found"
          fi

  rust-security:
    name: Rust Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Install cargo-audit
        run: cargo install cargo-audit
      
      - name: Run cargo-audit
        run: |
          # Scan each Rust package
          for cargo_file in $(find . -name "Cargo.toml" | grep -v node_modules | grep -v target); do
            dir=$(dirname "$cargo_file")
            echo "Scanning $dir"
            cd "$dir"
            cargo audit --json > "$(basename $dir)-audit.json" || true
            cd -
          done
      
      - name: Upload Rust vulnerability reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: rust-vulnerability-reports
          path: '**/*-audit.json'

  node-security:
    name: Node.js Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
      
      - name: Run npm audit
        run: |
          # Scan each Node.js package
          for package_file in $(find . -name "package.json" | grep -v node_modules); do
            dir=$(dirname "$package_file")
            echo "Scanning $dir"
            cd "$dir"
            if [ -f "package-lock.json" ]; then
              npm audit --json > "$(basename $dir)-audit.json" || true
            fi
            cd -
          done
      
      - name: Upload Node vulnerability reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: node-vulnerability-reports
          path: '**/*-audit.json'

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install license checker
        run: pip install pip-licenses
      
      - name: Check Python licenses
        run: |
          pip-licenses --format=json --with-license-file --output-file=python-licenses.json
          
          # Check for problematic licenses
          problematic=$(jq '[.[] | select(.License | test("GPL|AGPL|LGPL|SSPL|Commons Clause"))] | length' python-licenses.json)
          if [ $problematic -gt 0 ]; then
            echo "⚠️ Found $problematic packages with potentially problematic licenses"
            jq '[.[] | select(.License | test("GPL|AGPL|LGPL|SSPL|Commons Clause"))]' python-licenses.json
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
      
      - name: Install license-checker
        run: npm install -g license-checker
      
      - name: Check Node.js licenses
        run: |
          for package_file in $(find . -name "package.json" | grep -v node_modules); do
            dir=$(dirname "$package_file")
            echo "Checking licenses in $dir"
            cd "$dir"
            if [ -f "package-lock.json" ]; then
              license-checker --json --out "$(basename $dir)-licenses.json" || true
            fi
            cd -
          done
      
      - name: Upload license reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: license-reports
          path: |
            python-licenses.json
            **/*-licenses.json

  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: [python-security, rust-security, node-security]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install SBOM tools
        run: |
          # Install syft for SBOM generation
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Generate SBOM
        run: |
          syft . -o cyclonedx-json > sbom.json
          syft . -o spdx-json > sbom-spdx.json
      
      - name: Upload SBOM
        uses: actions/upload-artifact@v3
        with:
          name: sbom
          path: |
            sbom.json
            sbom-spdx.json
      
      - name: Scan SBOM for vulnerabilities
        run: |
          # Install grype for vulnerability scanning
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          
          # Scan the SBOM
          grype sbom:sbom.json -o json > vulnerability-report.json
          
          # Check for critical/high vulnerabilities
          critical=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' vulnerability-report.json)
          high=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' vulnerability-report.json)
          
          echo "Found $critical CRITICAL and $high HIGH vulnerabilities"
          
          if [ $critical -gt 0 ]; then
            echo "❌ Critical vulnerabilities detected!"
            jq '.matches[] | select(.vulnerability.severity == "Critical") | {package: .artifact.name, version: .artifact.version, vulnerability: .vulnerability.id, severity: .vulnerability.severity}' vulnerability-report.json
            exit 1
          fi
      
      - name: Upload vulnerability report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: vulnerability-report
          path: vulnerability-report.json

  create-report:
    name: Create Summary Report
    runs-on: ubuntu-latest
    needs: [python-security, rust-security, node-security, license-check, generate-sbom]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Generate summary report
        run: |
          echo "# Dependency Security Report" > report.md
          echo "Date: $(date)" >> report.md
          echo "" >> report.md
          
          # Python vulnerabilities
          echo "## Python Dependencies" >> report.md
          if ls python-vulnerability-reports/*-audit.json 1> /dev/null 2>&1; then
            for file in python-vulnerability-reports/*-audit.json; do
              vuln_count=$(jq '.vulnerabilities | length' "$file")
              echo "- $(basename $file .json): $vuln_count vulnerabilities" >> report.md
            done
          fi
          echo "" >> report.md
          
          # Rust vulnerabilities
          echo "## Rust Dependencies" >> report.md
          if ls rust-vulnerability-reports/*-audit.json 1> /dev/null 2>&1; then
            for file in rust-vulnerability-reports/*-audit.json; do
              vuln_count=$(jq '.vulnerabilities.list | length' "$file" 2>/dev/null || echo 0)
              echo "- $(basename $file .json): $vuln_count vulnerabilities" >> report.md
            done
          fi
          echo "" >> report.md
          
          # Node vulnerabilities
          echo "## Node.js Dependencies" >> report.md
          if ls node-vulnerability-reports/*-audit.json 1> /dev/null 2>&1; then
            for file in node-vulnerability-reports/*-audit.json; do
              vuln_count=$(jq '.vulnerabilities | length' "$file" 2>/dev/null || echo 0)
              echo "- $(basename $file .json): $vuln_count vulnerabilities" >> report.md
            done
          fi
          echo "" >> report.md
          
          # License summary
          echo "## License Summary" >> report.md
          if [ -f "license-reports/python-licenses.json" ]; then
            unique_licenses=$(jq '[.[].License] | unique | length' license-reports/python-licenses.json)
            echo "- Python: $unique_licenses unique licenses" >> report.md
          fi
          echo "" >> report.md
          
          # SBOM
          echo "## Software Bill of Materials" >> report.md
          if [ -f "sbom/sbom.json" ]; then
            component_count=$(jq '.components | length' sbom/sbom.json)
            echo "- Total components: $component_count" >> report.md
          fi
          
          cat report.md
      
      - name: Upload final report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: report.md
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });