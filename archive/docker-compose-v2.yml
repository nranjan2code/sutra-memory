services:
  # Rust gRPC Storage Server (core backend)
  storage-server:
    image: sutra-storage-server:v2
    container_name: sutra-storage
    ports:
      - "50051:50051"
    volumes:
      - storage-data:/data
    environment:
      - RUST_LOG=info
      - STORAGE_PATH=/data
      - STORAGE_HOST=0.0.0.0
      - STORAGE_PORT=50051
    networks:
      - sutra-network
    restart: unless-stopped

  # Sutra API (primary REST API)
  sutra-api:
    image: sutra-api:v2
    container_name: sutra-api
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - SUTRA_STORAGE_MODE=server
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_RATE_LIMIT_LEARN=100
      - SUTRA_RATE_LIMIT_REASON=200
    depends_on:
      - storage-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - sutra-network
    restart: unless-stopped

  # Sutra Hybrid (semantic embeddings API)
  sutra-hybrid:
    image: sutra-hybrid:v2
    container_name: sutra-hybrid
    ports:
      - "8001:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - SUTRA_STORAGE_MODE=server
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_USE_SEMANTIC_EMBEDDINGS=true
    depends_on:
      - storage-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - sutra-network
    restart: unless-stopped

  # Sutra Control Panel (lifecycle management)
  sutra-control:
    image: sutra-control:v2
    container_name: sutra-control
    ports:
      - "5001:5000"
    environment:
      - PYTHONUNBUFFERED=1
      - SUTRA_STORAGE_MODE=server
      - SUTRA_STORAGE_SERVER=storage-server:50051
    depends_on:
      - sutra-api
      - sutra-hybrid
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - sutra-network
    restart: unless-stopped

  # React Web Client
  sutra-client:
    image: sutra-client:v2
    container_name: sutra-client
    ports:
      - "8080:8080"
    depends_on:
      - sutra-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - sutra-network
    restart: unless-stopped

volumes:
  storage-data:
    driver: local

networks:
  sutra-network:
    driver: bridge
