services:
  # ============================================================================
  # STORAGE LAYER
  # ============================================================================
  
  # Main Storage Server (Core Sutra AI Knowledge Graph)
  storage-server:
    build:
      context: .
      dockerfile: ./packages/sutra-storage/Dockerfile
    image: sutra-storage-server:latest
    container_name: sutra-storage
    ports:
      - "50051:50051"
    volumes:
      - storage-data:/data
    environment:
      - RUST_LOG=info
      - STORAGE_PATH=/data
      - STORAGE_HOST=0.0.0.0
      - STORAGE_PORT=50051
      - VECTOR_DIMENSION=768
      # Unified Learning Pipeline Configuration
      - SUTRA_EMBEDDING_SERVICE_URL=http://sutra-embedding-service:8888
      - SUTRA_EMBEDDING_TIMEOUT_SEC=30
      - SUTRA_MIN_ASSOCIATION_CONFIDENCE=0.5
      - SUTRA_MAX_ASSOCIATIONS_PER_CONCEPT=10
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Grid Event Storage (Reserved for Grid Observability)
  grid-event-storage:
    build:
      context: .
      dockerfile: ./packages/sutra-storage/Dockerfile
    image: sutra-storage-server:latest
    container_name: sutra-grid-events
    ports:
      - "50052:50051"
    volumes:
      - grid-event-data:/data
    environment:
      - RUST_LOG=info
      - STORAGE_PATH=/data
      - STORAGE_HOST=0.0.0.0
      - STORAGE_PORT=50051
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================================================
  # GRID INFRASTRUCTURE
  # ============================================================================
  
  # Grid Master (Orchestration & Coordination)
  grid-master:
    build:
      context: .
      dockerfile: ./packages/sutra-grid-master/Dockerfile
    image: sutra-grid-master:latest
    container_name: sutra-grid-master
    ports:
      - "7001:7001"  # HTTP binary distribution
      - "7002:7002"  # TCP agent connections
    environment:
      - RUST_LOG=info
      - GRID_MASTER_HOST=0.0.0.0
      - GRID_MASTER_TCP_PORT=7002
      - GRID_MASTER_HTTP_PORT=7001
      - EVENT_STORAGE=grid-event-storage:50051
    depends_on:
      - grid-event-storage
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "7002"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Grid Agent 1 (Node Management)
  grid-agent-1:
    build:
      context: .
      dockerfile: ./packages/sutra-grid-agent/Dockerfile
    image: sutra-grid-agent:latest
    container_name: sutra-grid-agent-1
    ports:
      - "8003:8001"
    volumes:
      - agent1-data:/storage-nodes
    environment:
      - RUST_LOG=info
      - GRID_AGENT_HOST=0.0.0.0
      - GRID_AGENT_PORT=8001
      - GRID_MASTER_ADDRESS=grid-master:7002
      - EVENT_STORAGE=grid-event-storage:50051
      - AGENT_ID=agent-001
      - MAX_STORAGE_NODES=5
    depends_on:
      - grid-master
      - grid-event-storage
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "grid-master", "7002"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  # Grid Agent 2 (Additional Node Management)
  grid-agent-2:
    build:
      context: .
      dockerfile: ./packages/sutra-grid-agent/Dockerfile
    image: sutra-grid-agent:latest
    container_name: sutra-grid-agent-2
    ports:
      - "8004:8001"
    volumes:
      - agent2-data:/storage-nodes
    environment:
      - RUST_LOG=info
      - GRID_AGENT_HOST=0.0.0.0
      - GRID_AGENT_PORT=8001
      - GRID_MASTER_ADDRESS=grid-master:7002
      - EVENT_STORAGE=grid-event-storage:50051
      - AGENT_ID=agent-002
      - MAX_STORAGE_NODES=5
    depends_on:
      - grid-master
      - grid-event-storage
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "grid-master", "7002"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  # ============================================================================
  # API LAYER
  # ============================================================================
  
  # Sutra API (Primary REST API)
  sutra-api:
    build:
      context: .
      dockerfile: ./packages/sutra-api/Dockerfile
    image: sutra-api:latest
    container_name: sutra-api
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - SUTRA_STORAGE_MODE=server
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_RATE_LIMIT_LEARN=100
      - SUTRA_RATE_LIMIT_REASON=200
    depends_on:
      - storage-server
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Sutra Embedding Service (High-Performance nomic-embed-text-v1.5)
  sutra-embedding-service:
    build:
      context: ./packages/sutra-embedding-service
      dockerfile: Dockerfile
    image: sutra-embedding-service:latest
    container_name: sutra-embedding-service
    ports:
      - "8888:8888"
    environment:
      - PORT=8888
      - EMBEDDING_MODEL=nomic-ai/nomic-embed-text-v1.5
      - EMBEDDING_BATCH_SIZE=64
      - EMBEDDING_MAX_WAIT_MS=50
      - TRANSFORMERS_CACHE=/tmp/.cache/huggingface
      - HF_HOME=/tmp/.cache/huggingface
      - HOME=/tmp
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8888/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Longer start period for model loading
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

  # Sutra Hybrid (Semantic Embeddings API)
  sutra-hybrid:
    build:
      context: .
      dockerfile: ./packages/sutra-hybrid/Dockerfile
    image: sutra-hybrid:latest
    container_name: sutra-hybrid
    ports:
      - "8001:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - SUTRA_STORAGE_MODE=server
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_USE_SEMANTIC_EMBEDDINGS=true
      - SUTRA_EMBEDDING_PROVIDER=service
      - SUTRA_EMBEDDING_SERVICE_URL=http://sutra-embedding-service:8888
      - SUTRA_EMBEDDING_MODEL=nomic-embed-text
      - SUTRA_VECTOR_DIMENSION=768
    depends_on:
      - storage-server
      - sutra-embedding-service
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================================================
  # WEB INTERFACES
  # ============================================================================
  
  # Sutra Control Center (Grid Management + System Monitoring)
  sutra-control:
    build:
      context: .
      dockerfile: ./packages/sutra-control/Dockerfile
    image: sutra-control:grid-integrated
    container_name: sutra-control
    ports:
      - "9000:9000"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - ENVIRONMENT=production
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_GRID_MASTER=grid-master:7001
      - PORT=9000
    depends_on:
      - storage-server
      - grid-master
      - sutra-api
      - sutra-hybrid
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s


  # Sutra Client (Interactive AI Interface)
  sutra-client:
    build:
      context: ./packages/sutra-client
      dockerfile: Dockerfile
    image: sutra-client:latest
    container_name: sutra-client
    ports:
      - "8080:8080"
    environment:
      - SUTRA_API_URL=http://sutra-api:8000
      - SUTRA_HYBRID_URL=http://sutra-hybrid:8000
    depends_on:
      - sutra-api
      - sutra-hybrid
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================================================
  # BULK INGESTION LAYER (Optional - can be disabled)
  # ============================================================================
  
  # Primary Bulk Ingester Service (Optional)
  sutra-bulk-ingester:
    build:
      context: .
      dockerfile: ./packages/sutra-bulk-ingester/Dockerfile
    image: sutra-bulk-ingester:latest
    container_name: sutra-bulk-ingester
    ports:
      - "8005:8005"  # Bulk ingestion API
    volumes:
      - ./datasets:/datasets:ro  # Read-only dataset access
      - ingestion-jobs:/jobs     # Job state persistence
    environment:
      - RUST_LOG=info
      - SUTRA_STORAGE_MODE=server
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_EMBEDDING_SERVICE_URL=http://sutra-embedding-service:8888
      - SUTRA_GRID_MASTER=grid-master:7001
      - INGESTER_WORKERS=2
      - INGESTER_BATCH_SIZE=100
      - INGESTER_MEMORY_LIMIT=2048
    depends_on:
      storage-server:
        condition: service_healthy
      grid-master:
        condition: service_healthy
    networks:
      - sutra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 20s
    profiles:
      - bulk-ingester  # Optional profile - only start when requested

# ============================================================================
# NETWORKING & STORAGE
# ============================================================================

volumes:
  # Docker managed volumes (easier for deployment)
  storage-data:
    driver: local
  grid-event-data:
    driver: local
  agent1-data:
    driver: local
  agent2-data:
    driver: local
  # New volume for bulk ingestion (only created when bulk-ingester profile used)
  ingestion-jobs:
    driver: local

networks:
  sutra-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
