# Development Docker Compose Override
# Usage: docker-compose -f docker-compose-grid.yml -f docker-compose.dev.yml up
# This enables hot-reload for fast development without rebuilds!

services:
  # ============================================================================
  # Python Services - Hot Reload with Volume Mounts
  # ============================================================================
  
  sutra-api:
    volumes:
      # Mount source code for instant changes (no rebuild needed!)
      - ./packages/sutra-api/sutra_api:/app/sutra_api
      - ./packages/sutra-storage-client-tcp/sutra_storage_client:/usr/local/lib/python3.11/site-packages/sutra_storage_client
    environment:
      - PYTHON_ENV=development
      - PYTHONUNBUFFERED=1
    command: ["python", "-m", "uvicorn", "sutra_api.main:app", "--reload", "--host", "0.0.0.0", "--port", "8000"]
    
  sutra-hybrid:
    volumes:
      - ./packages/sutra-hybrid/sutra_hybrid:/app/sutra_hybrid
      - ./packages/sutra-storage-client-tcp/sutra_storage_client:/usr/local/lib/python3.11/site-packages/sutra_storage_client
    environment:
      - PYTHON_ENV=development
      - PYTHONUNBUFFERED=1
    command: ["python", "-m", "uvicorn", "sutra_hybrid.main:app", "--reload", "--host", "0.0.0.0", "--port", "8001"]

  # ============================================================================
  # Frontend Services - Hot Reload with Vite
  # ============================================================================
  
  sutra-client:
    build:
      context: ./packages/sutra-client
      target: development  # Use dev stage if Dockerfile supports it
    volumes:
      # Mount source for Vite hot reload
      - ./packages/sutra-client/src:/app/src
      - ./packages/sutra-client/index.html:/app/index.html
      - ./packages/sutra-client/vite.config.ts:/app/vite.config.ts
      # Keep node_modules in container (faster)
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8000
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    ports:
      - "5173:5173"  # Vite dev server with HMR

  # ============================================================================
  # Rust Services - Faster Rebuilds with Cargo Cache
  # ============================================================================
  
  storage-server:
    volumes:
      # Cache Cargo registry for faster rebuilds
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      # Note: Can't hot-reload Rust, but cache makes rebuilds 10x faster
    environment:
      - RUST_LOG=debug  # More verbose logging in dev

  grid-master:
    volumes:
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
    environment:
      - RUST_LOG=debug

# Shared volumes for build caching
volumes:
  cargo-registry:
  cargo-git: