services:
  # Core biological intelligence service
  core-service:
    build: 
      context: .
      dockerfile: docker/Dockerfile.core
    container_name: biological-intelligence-core
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app
      - WORKSPACE_PATH=/app/biological_workspace
    volumes:
      - ./biological_workspace:/app/biological_workspace
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - biological-network

  # Web GUI service
  web-gui:
    build:
      context: .
      dockerfile: docker/Dockerfile.webgui
    container_name: biological-web-gui
    depends_on:
      core-service:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      - PYTHONPATH=/app
      - CORE_SERVICE_URL=http://core-service:8000
      - WEB_HOST=0.0.0.0
      - WEB_PORT=8080
    volumes:
      - ./biological_workspace:/app/biological_workspace
      - ./logs:/app/logs
      - ./web_templates:/app/web_templates
      - ./web_static:/app/web_static
    restart: unless-stopped
    networks:
      - biological-network

  # Optional: Distributed trainer (remove if not needed)
  distributed-trainer:
    build:
      context: .
      dockerfile: docker/Dockerfile.trainer
    container_name: biological-trainer
    depends_on:
      core-service:
        condition: service_healthy
    environment:
      - PYTHONPATH=/app
      - CORE_SERVICE_URL=http://core-service:8000
    volumes:
      - ./logs:/app/logs
      - ./enhanced_english_curriculum:/app/enhanced_english_curriculum
    command: ["python", "distributed_trainer.py", "--core-url", "http://core-service:8000", "--progressive-all", "--one-time"]
    restart: "no"  # Prevent infinite training loops
    networks:
      - biological-network

  # Optional: Interactive client (remove if not needed)
  distributed-client:
    build:
      context: .
      dockerfile: docker/Dockerfile.client
    container_name: biological-client-interactive
    depends_on:
      core-service:
        condition: service_healthy
    environment:
      - PYTHONPATH=/app
      - CORE_SERVICE_URL=http://core-service:8000
    volumes:
      - ./logs:/app/logs
    stdin_open: true
    tty: true
    command: ["python", "distributed_client.py", "--core-url", "http://core-service:8000", "--interactive"]
    restart: unless-stopped
    networks:
      - biological-network

networks:
  biological-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  biological-workspace:
    driver: local
  logs:
    driver: local