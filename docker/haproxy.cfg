# HAProxy Configuration for Sutra Embedding Service HA
# 
# Architecture: 3 replicas with least-connection load balancing
# Health checks: HTTP GET /health every 2 seconds
# Failover: Automatic with 3-second timeout

global
    log stdout format raw local0 info
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    timeout check   3000ms
    
    # Error handling
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Statistics endpoint for monitoring
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:sutra-ha-2024

# Embedding Service Frontend
frontend embedding-frontend
    bind *:8888
    default_backend embedding-services
    
    # Request logging
    option httplog
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    
    # Add headers for debugging
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Request-ID %[uuid()]
    
    # CORS for browser access (if needed)
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type"

# Embedding Service Backend (3 replicas)
backend embedding-services
    # Load balancing algorithm
    # leastconn = send to server with fewest active connections
    balance leastconn
    
    # Health check configuration (HAProxy 2.8+ syntax)
    http-check send meth GET uri /health ver HTTP/1.1 hdr Host embedding
    http-check expect status 200
    
    # Server options
    option log-health-checks
    option tcp-check
    
    # Retry policy
    retry-on all-retryable-errors
    retries 3
    
    # Timeout configuration
    timeout connect 5s
    timeout server 30s
    
    # Server definitions (3 replicas)
    # Format: server <name> <host>:<port> check inter <interval> fall <failures> rise <successes>
    server embedding-1 embedding-1:8888 check inter 2000ms fall 3 rise 2 weight 100
    server embedding-2 embedding-2:8888 check inter 2000ms fall 3 rise 2 weight 100
    server embedding-3 embedding-3:8888 check inter 2000ms fall 3 rise 2 weight 100
    
    # Backup server (optional - for graceful degradation)
    # server embedding-backup embedding-backup:8888 check inter 5000ms backup

# Error handling pages (removed custom error file that doesn't exist)
# listen error-pages
#     bind *:8405
