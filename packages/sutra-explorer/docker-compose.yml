# Sutra Explorer - Docker Compose Configuration

services:
  # Sutra Explorer Backend (FastAPI)
  sutra-explorer-backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    image: sutra-explorer-backend:${SUTRA_VERSION:-latest}
    container_name: sutra-explorer-backend
    ports:
      - "8100:8100"
    environment:
      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8100
      - LOG_LEVEL=INFO
      
      # Storage Client Connections (via TCP binary protocol)
      - SUTRA_USER_STORAGE=user-storage-server:50051
      - SUTRA_DOMAIN_STORAGE=storage-server:50051
      
      # Optional: Additional domain storages (comma-separated)
      # Format: name=host:port,name2=host2:port2
      # - SUTRA_ADDITIONAL_STORAGES=medical=medical-storage:50051,legal=legal-storage:50051
      
      # CORS Configuration
      - CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:8080
      
      # Edition (inherited from platform)
      - SUTRA_EDITION=${SUTRA_EDITION:-simple}
    
    depends_on:
      - storage-server
      - user-storage-server
    
    networks:
      - sutra-network
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Sutra Explorer Frontend (React + Vite)
  sutra-explorer-frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
      args:
        - VITE_API_URL=http://localhost:8100
    image: sutra-explorer-frontend:${SUTRA_VERSION:-latest}
    container_name: sutra-explorer-frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://sutra-explorer-backend:8100
    
    depends_on:
      - sutra-explorer-backend
    
    networks:
      - sutra-network
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  sutra-network:
    external: true
    name: sutra_sutra-network

# NOTE: This compose file is meant to be used alongside the main
# Sutra platform compose file (.sutra/compose/production.yml)
# 
# To run explorer with full platform:
# 1. Start platform: cd .sutra/compose && docker compose -f production.yml up -d
# 2. Start explorer: cd packages/sutra-explorer && docker compose up -d
# 
# The explorer will connect to existing storage servers via TCP binary protocol.
