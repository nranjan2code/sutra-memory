#!/usr/bin/env python3
"""
Sutra - Unified Build & Deploy System
Single entry point for all Sutra operations

Usage:
    sutra build [SERVICE...]       Build services
    sutra deploy [OPTIONS]         Deploy system
    sutra validate                 Validate images
    sutra test [TYPE]              Run tests
    sutra clean [OPTIONS]          Clean up
    sutra version                  Show version
    sutra help                     Show detailed help
"""

import sys
import os
import subprocess
import argparse
from pathlib import Path
from typing import List, Optional

try:
    import requests
except ImportError:
    requests = None

# Constants
VERSION = "3.0.1"
SUTRA_ROOT = Path(__file__).parent.absolute()
SUTRA_DIR = SUTRA_ROOT / ".sutra"
BUILD_DIR = SUTRA_DIR / "build"
DEPLOY_DIR = SUTRA_DIR / "deploy"

# Color codes
class Colors:
    RED = '\033[0;31m'
    GREEN = '\033[0;32m'
    YELLOW = '\033[1;33m'
    BLUE = '\033[0;34m'
    CYAN = '\033[0;36m'
    BOLD = '\033[1m'
    NC = '\033[0m'

def log_info(msg: str):
    print(f"{Colors.BLUE}â„¹ {Colors.NC}{msg}")

def log_success(msg: str):
    print(f"{Colors.GREEN}âœ“{Colors.NC} {msg}")

def log_error(msg: str):
    print(f"{Colors.RED}âœ—{Colors.NC} {msg}", file=sys.stderr)

def log_warning(msg: str):
    print(f"{Colors.YELLOW}âš {Colors.NC} {msg}")

def run_command(cmd: List[str], cwd: Optional[Path] = None, check: bool = True) -> subprocess.CompletedProcess:
    """Run shell command with logging"""
    log_info(f"Running: {' '.join(cmd)}")
    return subprocess.run(cmd, cwd=cwd or SUTRA_ROOT, check=check)

def print_banner():
    """Print Sutra banner"""
    print(f"{Colors.CYAN}")
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘                    ðŸš€ SUTRA BUILD SYSTEM                      â•‘")
    print("â•‘              Unified Build, Deploy & Test Platform           â•‘")
    print(f"â•‘                        Version {VERSION}                         â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print(f"{Colors.NC}")

# Command implementations

def cmd_build(args):
    """Build services"""
    services = args.services if args.services else ["all"]
    edition = os.environ.get("SUTRA_EDITION", "simple")
    
    log_info(f"Building services: {', '.join(services)}")
    log_info(f"Edition: {edition}")
    
    # Call existing sutra-optimize.sh for now (will be migrated)
    build_script = SUTRA_ROOT / "sutra-optimize.sh"
    
    if services == ["all"]:
        run_command([str(build_script), "build-all"])
    else:
        for service in services:
            run_command([str(build_script), "build", service])
    
    log_success("Build completed")

def cmd_deploy(args):
    """Deploy system"""
    # Load production-optimized defaults (Phase 0+1+2)
    env_file = SUTRA_ROOT / ".env.production"
    if env_file.exists():
        log_info("Loading production-optimized configuration (Phase 0+1+2)")
        with open(env_file) as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    if key not in os.environ:  # Don't override explicit env vars
                        os.environ[key] = value
    
    edition = os.environ.get("SUTRA_EDITION", args.edition or "community")
    
    log_info(f"Deploying Sutra {edition} edition")
    log_info(f"Performance: 21Ã— improvement with Phase 0+1+2 scaling")
    log_info(f"Matryoshka: {os.environ.get('MATRYOSHKA_DIM', '256')}-dim embeddings")
    log_info(f"Cache: {'enabled' if os.environ.get('SUTRA_CACHE_ENABLED', 'true') == 'true' else 'disabled'}")
    
    # Call existing sutra-optimize.sh for now
    deploy_script = SUTRA_ROOT / "sutra-optimize.sh"
    run_command([str(deploy_script), "deploy"])
    
    log_success("Deployment completed")

def cmd_validate(args):
    """Validate images"""
    log_info("Validating deployment images...")
    
    # Check essential images exist
    essential_images = [
        "sutra-storage-server",
        "sutra-api",
        "sutra-hybrid",
        "sutra-control",
        "sutra-client",
        "sutra-explorer-backend",
        "sutra-explorer-frontend",
        "sutra-ml-base-service",
        "sutra-embedding-service",
        "sutra-nlg-service"
    ]
    
    missing_images = []
    for image in essential_images:
        result = subprocess.run(
            ["docker", "images", "--format", "{{.Repository}}", "--filter", f"reference={image}:*"],
            capture_output=True, text=True
        )
        if not result.stdout.strip():
            missing_images.append(image)
    
    if missing_images:
        log_error(f"Missing images: {', '.join(missing_images)}")
        log_info("Run 'sutra build' to build missing images")
        sys.exit(1)
    
    log_success(f"All {len(essential_images)} essential images found")
    log_success("Validation passed")

def cmd_test(args):
    """Run tests"""
    test_type = args.type or "smoke"
    
    log_info(f"Running {test_type} tests...")
    
    if test_type == "smoke":
        if requests is None:
            log_warning("requests library not available, skipping HTTP tests")
            log_info("Install requests: pip install requests")
            # Fallback to Docker ps check
            try:
                result = subprocess.run(
                    ["docker", "compose", "-p", "sutra-works", "-f", ".sutra/compose/production.yml", "ps"],
                    capture_output=True, text=True, check=True
                )
                running_count = len([line for line in result.stdout.split('\n') if 'Up' in line])
                log_success(f"Basic smoke test passed - {running_count} services running")
            except subprocess.CalledProcessError:
                log_error("Smoke test failed - Docker compose not running")
                sys.exit(1)
        else:
            # HTTP-based smoke test
            services_to_test = [
                ("API", "http://localhost:8000/health"),
                ("Hybrid", "http://localhost:8001/ping"),
                ("Control", "http://localhost:9000/health"),
                ("ML Base", "http://localhost:8887/health"),
                ("Embedding", "http://localhost:8888/health")
            ]
            
            failed_tests = []
            for service_name, url in services_to_test:
                try:
                    response = requests.get(url, timeout=5)
                    if response.status_code == 200:
                        log_success(f"{service_name} service: OK")
                    else:
                        log_error(f"{service_name} service: HTTP {response.status_code}")
                        failed_tests.append(service_name)
                except requests.exceptions.RequestException as e:
                    log_warning(f"{service_name} service: Not responding ({e})")
                    failed_tests.append(service_name)
            
            if failed_tests:
                log_error(f"Failed tests: {', '.join(failed_tests)}")
                log_info("Some services may still be starting up")
                sys.exit(1)
            
    elif test_type == "integration":
        log_info("Running basic integration test...")
        # Simple integration test - verify Docker containers are running
        try:
            result = subprocess.run(
                ["docker", "ps", "--filter", "name=sutra-", "--format", "{{.Names}}"],
                capture_output=True, text=True, check=True
            )
            running_containers = [line.strip() for line in result.stdout.split('\n') if line.strip()]
            running_count = len(running_containers)
            
            if running_count >= 5:  # We expect at least 5 core services
                log_success(f"Integration test passed - {running_count} Sutra services running")
                for container in running_containers:
                    log_info(f"  â†’ {container}")
            else:
                log_error(f"Integration test failed - only {running_count} services running")
                sys.exit(1)
        except subprocess.CalledProcessError as e:
            log_error(f"Integration test failed - Error checking containers: {e}")
            sys.exit(1)
    else:
        log_error(f"Unknown test type: {test_type}")
        sys.exit(1)
    
    log_success(f"{test_type.capitalize()} tests passed")

def cmd_clean(args):
    """Clean up"""
    log_info("Cleaning up Docker resources...")
    
    if args.images:
        log_info("Removing untagged images...")
        run_command(["docker", "image", "prune", "-f"], check=False)
    
    if args.containers:
        log_info("Removing stopped containers...")
        run_command(["docker", "container", "prune", "-f"], check=False)
    
    if args.volumes:
        log_warning("Removing volumes (data will be lost!)...")
        if input("Are you sure? [y/N] ").lower() == 'y':
            run_command(["docker", "volume", "prune", "-f"], check=False)
    
    if args.all:
        log_warning("Full cleanup (this will remove everything)...")
        if input("Are you sure? [y/N] ").lower() == 'y':
            run_command(["docker", "system", "prune", "-af", "--volumes"], check=False)
    
    log_success("Cleanup completed")

def cmd_version(args):
    """Show version"""
    print(f"Sutra Build System v{VERSION}")
    print(f"Python: {sys.version}")
    print(f"Location: {SUTRA_ROOT}")

def cmd_status(args):
    """Show system status"""
    log_info("Checking Sutra system status...")
    
    # Check Docker
    try:
        subprocess.run(["docker", "version"], capture_output=True, check=True)
        log_success("Docker: Running")
    except:
        log_error("Docker: Not running")
    
    # Check running containers
    result = subprocess.run(
        ["docker", "ps", "--filter", "name=sutra-", "--format", "{{.Names}}"],
        capture_output=True, text=True
    )
    containers = result.stdout.strip().split('\n') if result.stdout.strip() else []
    
    if containers:
        log_success(f"Running containers: {len(containers)}")
        for container in containers:
            print(f"  â€¢ {container}")
    else:
        log_warning("No Sutra containers running")
    
    # Check images
    result = subprocess.run(
        ["docker", "images", "--filter", "reference=sutra-*", "--format", "{{.Repository}}:{{.Tag}}"],
        capture_output=True, text=True
    )
    images = result.stdout.strip().split('\n') if result.stdout.strip() else []
    
    if images:
        log_success(f"Built images: {len(images)}")
    else:
        log_warning("No Sutra images found")

def main():
    # Handle help alias
    if len(sys.argv) > 1 and sys.argv[1] in ['help', '--help', '-h']:
        sys.argv[1] = '--help'
    
    parser = argparse.ArgumentParser(
        description="Sutra Unified Build & Deploy System",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  sutra build                    Build all services
  sutra build embedding nlg      Build specific services
  sutra deploy                   Deploy system
  sutra validate                 Validate images
  sutra test smoke               Run smoke tests
  sutra clean --images           Clean untagged images
  sutra status                   Show system status
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Command to execute')
    
    # Build command
    build_parser = subparsers.add_parser('build', help='Build services')
    build_parser.add_argument('services', nargs='*', help='Services to build (default: all)')
    build_parser.add_argument('--no-cache', action='store_true', help='Build without cache')
    build_parser.set_defaults(func=cmd_build)
    
    # Deploy command
    deploy_parser = subparsers.add_parser('deploy', help='Deploy system')
    deploy_parser.add_argument('--edition', choices=['simple', 'community', 'enterprise'], 
                               default='simple', help='Edition to deploy')
    deploy_parser.set_defaults(func=cmd_deploy)
    
    # Validate command
    validate_parser = subparsers.add_parser('validate', help='Validate images')
    validate_parser.set_defaults(func=cmd_validate)
    
    # Test command
    test_parser = subparsers.add_parser('test', help='Run tests')
    test_parser.add_argument('type', nargs='?', choices=['smoke', 'integration'], 
                            default='smoke', help='Test type')
    test_parser.set_defaults(func=cmd_test)
    
    # Clean command
    clean_parser = subparsers.add_parser('clean', help='Clean up')
    clean_parser.add_argument('--images', action='store_true', help='Clean images')
    clean_parser.add_argument('--containers', action='store_true', help='Clean containers')
    clean_parser.add_argument('--volumes', action='store_true', help='Clean volumes')
    clean_parser.add_argument('--all', action='store_true', help='Full cleanup')
    clean_parser.set_defaults(func=cmd_clean)
    
    # Version command
    version_parser = subparsers.add_parser('version', help='Show version')
    version_parser.set_defaults(func=cmd_version)
    
    # Status command
    status_parser = subparsers.add_parser('status', help='Show system status')
    status_parser.set_defaults(func=cmd_status)
    
    args = parser.parse_args()
    
    if not args.command:
        print_banner()
        parser.print_help()
        sys.exit(0)
    
    # Execute command
    try:
        if hasattr(args, 'func'):
            args.func(args)
        else:
            parser.print_help()
    except KeyboardInterrupt:
        log_warning("\nOperation cancelled by user")
        sys.exit(130)
    except Exception as e:
        log_error(f"Error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
