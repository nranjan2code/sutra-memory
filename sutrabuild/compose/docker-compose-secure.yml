# Production-Secure Docker Compose Configuration
# 
# Security Features:
# - Network segregation (internal/public)
# - Authentication on all services
# - TLS encryption
# - Minimal port exposure
# - Secrets management

services:
  # ============================================================================
  # STORAGE LAYER (INTERNAL ONLY - No External Exposure)
  # ============================================================================
  
  storage-server:
    build:
      context: .
      dockerfile: ./packages/sutra-storage/Dockerfile
    image: sutra-storage-server:latest
    container_name: sutra-storage
    # ‚ùå NO EXTERNAL PORTS - Internal communication only
    expose:
      - "50051"  # Only exposed to internal network
    volumes:
      - storage-data:/data
      - ./.secrets/tls:/secrets/tls:ro  # TLS certificates
    environment:
      - RUST_LOG=info
      - STORAGE_PATH=/data
      - STORAGE_HOST=0.0.0.0
      - STORAGE_PORT=50051
      - VECTOR_DIMENSION=768
      
      # Storage Configuration
      - SUTRA_STORAGE_MODE=sharded
      - SUTRA_NUM_SHARDS=4
      
      # üîí AUTHENTICATION (REQUIRED)
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
      - SUTRA_AUTH_METHOD=hmac
      - SUTRA_TOKEN_TTL_SECONDS=3600
      
      # üîê TLS ENCRYPTION
      - SUTRA_TLS_ENABLED=${SUTRA_TLS_ENABLED:-false}
      - SUTRA_TLS_CERT=/secrets/tls/cert.pem
      - SUTRA_TLS_KEY=/secrets/tls/key.pem
      
      # Embedding Service (Internal HA)
      - SUTRA_EMBEDDING_SERVICE_URL=http://embedding-ha:8888
      - SUTRA_EMBEDDING_TIMEOUT_SEC=30
      - SUTRA_MIN_ASSOCIATION_CONFIDENCE=0.5
      - SUTRA_MAX_ASSOCIATIONS_PER_CONCEPT=10
    networks:
      - sutra-internal  # ‚úÖ Internal network only
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Grid Event Storage (INTERNAL ONLY)
  grid-event-storage:
    build:
      context: .
      dockerfile: ./packages/sutra-storage/Dockerfile
    image: sutra-storage-server:latest
    container_name: sutra-grid-events
    # ‚ùå NO EXTERNAL PORTS
    expose:
      - "50051"
    volumes:
      - grid-event-data:/data
      - ./.secrets/tls:/secrets/tls:ro
    environment:
      - RUST_LOG=info
      - STORAGE_PATH=/data
      - STORAGE_HOST=0.0.0.0
      - STORAGE_PORT=50051
      - VECTOR_DIMENSION=768
      
      # üîí AUTHENTICATION
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
      - SUTRA_AUTH_METHOD=hmac
      - SUTRA_TOKEN_TTL_SECONDS=3600
      
      # üîê TLS
      - SUTRA_TLS_ENABLED=${SUTRA_TLS_ENABLED:-false}
      - SUTRA_TLS_CERT=/secrets/tls/cert.pem
      - SUTRA_TLS_KEY=/secrets/tls/key.pem
      
      - SUTRA_EMBEDDING_SERVICE_URL=http://embedding-ha:8888
      - SUTRA_EMBEDDING_TIMEOUT_SEC=30
    depends_on:
      - embedding-ha
    networks:
      - sutra-internal  # ‚úÖ Internal only
    restart: unless-stopped

  # ============================================================================
  # GRID INFRASTRUCTURE (INTERNAL ONLY)
  # ============================================================================
  
  grid-master:
    build:
      context: .
      dockerfile: ./packages/sutra-grid-master/Dockerfile
    image: sutra-grid-master:latest
    container_name: sutra-grid-master
    # ‚ùå NO EXTERNAL PORTS - Only internal communication
    expose:
      - "7001"  # HTTP API (internal only)
      - "7002"  # TCP agent connections (internal only)
    environment:
      - RUST_LOG=info
      - GRID_MASTER_HOST=0.0.0.0
      - GRID_MASTER_TCP_PORT=7002
      - GRID_MASTER_HTTP_PORT=7001
      - EVENT_STORAGE=grid-event-storage:50051
      
      # üîí AUTHENTICATION
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
    depends_on:
      - grid-event-storage
    networks:
      - sutra-internal  # ‚úÖ Internal only
    restart: unless-stopped

  grid-agent-1:
    build:
      context: .
      dockerfile: ./packages/sutra-grid-agent/Dockerfile
    image: sutra-grid-agent:latest
    container_name: sutra-grid-agent-1
    # ‚ùå NO EXTERNAL PORTS
    expose:
      - "8001"
    volumes:
      - agent1-data:/storage-nodes
    environment:
      - RUST_LOG=info
      - GRID_AGENT_HOST=0.0.0.0
      - GRID_AGENT_PORT=8001
      - GRID_MASTER_ADDRESS=grid-master:7002
      - EVENT_STORAGE=grid-event-storage:50051
      - AGENT_ID=agent-001
      - MAX_STORAGE_NODES=5
      
      # üîí AUTHENTICATION
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
    depends_on:
      - grid-master
    networks:
      - sutra-internal  # ‚úÖ Internal only
    restart: unless-stopped

  grid-agent-2:
    build:
      context: .
      dockerfile: ./packages/sutra-grid-agent/Dockerfile
    image: sutra-grid-agent:latest
    container_name: sutra-grid-agent-2
    # ‚ùå NO EXTERNAL PORTS
    expose:
      - "8001"
    volumes:
      - agent2-data:/storage-nodes
    environment:
      - RUST_LOG=info
      - GRID_AGENT_HOST=0.0.0.0
      - GRID_AGENT_PORT=8001
      - GRID_MASTER_ADDRESS=grid-master:7002
      - EVENT_STORAGE=grid-event-storage:50051
      - AGENT_ID=agent-002
      - MAX_STORAGE_NODES=5
      
      # üîí AUTHENTICATION
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
    depends_on:
      - grid-master
    networks:
      - sutra-internal  # ‚úÖ Internal only
    restart: unless-stopped

  # ============================================================================
  # EMBEDDING SERVICE (INTERNAL ONLY - HA Setup)
  # ============================================================================
  
  embedding-1:
    build:
      context: ./packages/sutra-embedding-service
      dockerfile: Dockerfile
    image: sutra-embedding-service:latest
    container_name: embedding-1
    # ‚ùå NO EXTERNAL PORTS
    expose:
      - "8888"
    environment:
      - RUST_LOG=info
      - EMBEDDING_PORT=8888
      - MODEL_PATH=/models/nomic-embed-text-v1.5
      - CACHE_SIZE=10000
      - BATCH_SIZE=32
      - INSTANCE_ID=embedding-1
    volumes:
      - ./packages/sutra-embedding-service/models:/models:ro
    networks:
      - sutra-internal  # ‚úÖ Internal only
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G

  embedding-2:
    image: sutra-embedding-service:latest
    container_name: embedding-2
    expose:
      - "8888"
    environment:
      - RUST_LOG=info
      - EMBEDDING_PORT=8888
      - MODEL_PATH=/models/nomic-embed-text-v1.5
      - CACHE_SIZE=10000
      - BATCH_SIZE=32
      - INSTANCE_ID=embedding-2
    volumes:
      - ./packages/sutra-embedding-service/models:/models:ro
    networks:
      - sutra-internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G

  embedding-3:
    image: sutra-embedding-service:latest
    container_name: embedding-3
    expose:
      - "8888"
    environment:
      - RUST_LOG=info
      - EMBEDDING_PORT=8888
      - MODEL_PATH=/models/nomic-embed-text-v1.5
      - CACHE_SIZE=10000
      - BATCH_SIZE=32
      - INSTANCE_ID=embedding-3
    volumes:
      - ./packages/sutra-embedding-service/models:/models:ro
    networks:
      - sutra-internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G

  # HAProxy Load Balancer (INTERNAL ONLY)
  embedding-ha:
    image: haproxy:2.8-alpine
    container_name: embedding-ha
    # ‚ùå NO EXTERNAL PORTS - Stats dashboard only internal
    expose:
      - "8888"  # Embedding service (internal only)
      - "8404"  # HAProxy stats (internal only)
    volumes:
      - ./docker/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - embedding-1
      - embedding-2
      - embedding-3
    networks:
      - sutra-internal  # ‚úÖ Internal only
    restart: unless-stopped

  # ============================================================================
  # API GATEWAY LAYER (PUBLIC FACING - Authentication Required)
  # ============================================================================
  
  # üåê PUBLIC: Main REST API (Authenticated)
  sutra-api:
    build:
      context: .
      dockerfile: ./packages/sutra-api/Dockerfile
    image: sutra-api:latest
    container_name: sutra-api
    ports:
      - "8000:8000"  # ‚úÖ PUBLIC - User authentication required
    environment:
      - PYTHONUNBUFFERED=1
      - SUTRA_STORAGE_MODE=server
      - SUTRA_STORAGE_SERVER=storage-server:50051
      
      # üîí AUTHENTICATION (REQUIRED for all API requests)
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
      - SUTRA_AUTH_METHOD=hmac
      - SUTRA_AUTH_ENABLED=true
      
      # Rate Limiting (Secured)
      - SUTRA_RATE_LIMIT_LEARN=100
      - SUTRA_RATE_LIMIT_REASON=200
      - SUTRA_BEHIND_PROXY=${SUTRA_BEHIND_PROXY:-false}
      - SUTRA_TRUSTED_PROXIES=${SUTRA_TRUSTED_PROXIES:-}
      
      # Service-to-Service Token
      - SUTRA_SERVICE_TOKEN=${SUTRA_SERVICE_TOKEN}
    depends_on:
      - storage-server
    networks:
      - sutra-internal  # Access to internal services
      - sutra-public    # ‚úÖ External access for users
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # üåê PUBLIC: Hybrid API (Authenticated)
  sutra-hybrid:
    build:
      context: .
      dockerfile: ./packages/sutra-hybrid/Dockerfile
    image: sutra-hybrid:latest
    container_name: sutra-hybrid
    ports:
      - "8001:8000"  # ‚úÖ PUBLIC - User authentication required
    environment:
      - PYTHONUNBUFFERED=1
      - SUTRA_STORAGE_MODE=server
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_USE_SEMANTIC_EMBEDDINGS=true
      - SUTRA_EMBEDDING_PROVIDER=service
      - SUTRA_EMBEDDING_SERVICE_URL=http://embedding-ha:8888
      - SUTRA_VECTOR_DIMENSION=768
      
      # üîí AUTHENTICATION
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
      - SUTRA_AUTH_METHOD=hmac
      - SUTRA_AUTH_ENABLED=true
      
      # Service Token
      - SUTRA_SERVICE_TOKEN=${SUTRA_SERVICE_TOKEN}
    depends_on:
      - storage-server
      - embedding-ha
    networks:
      - sutra-internal
      - sutra-public  # ‚úÖ External access
    restart: unless-stopped

  # ============================================================================
  # WEB INTERFACES (PUBLIC - With Authentication)
  # ============================================================================
  
  # üåê PUBLIC: Control Center (Admin Dashboard - Authenticated)
  sutra-control:
    build:
      context: .
      dockerfile: ./packages/sutra-control/Dockerfile
    image: sutra-control:grid-integrated
    container_name: sutra-control
    ports:
      - "9000:9000"  # ‚úÖ PUBLIC - Admin authentication required
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - ENVIRONMENT=production
      - PORT=9000
      
      # Backend proxy targets (internal)
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_GRID_MASTER=grid-master:7001
      - SUTRA_API_URL=http://sutra-api:8000
      - SUTRA_HYBRID_URL=http://sutra-hybrid:8000
      
      # üîí AUTHENTICATION
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
      - SUTRA_AUTH_METHOD=hmac
      - SUTRA_REQUIRE_AUTH=true
      - SUTRA_ADMIN_TOKEN=${SUTRA_ADMIN_TOKEN}
      
      # Service Token for backend calls
      - SUTRA_SERVICE_TOKEN=${SUTRA_SERVICE_TOKEN}
    depends_on:
      - storage-server
      - grid-master
      - sutra-api
      - sutra-hybrid
    networks:
      - sutra-internal  # Access to all internal services
      - sutra-public    # ‚úÖ External access for admins
    restart: unless-stopped

  # üåê PUBLIC: Client Interface (User Dashboard - Authenticated)
  sutra-client:
    build:
      context: ./packages/sutra-client
      dockerfile: Dockerfile
    image: sutra-client:latest
    container_name: sutra-client
    ports:
      - "8080:8080"  # ‚úÖ PUBLIC - User authentication required
    environment:
      # Public API endpoints only
      - SUTRA_API_URL=http://sutra-api:8000
      - SUTRA_HYBRID_URL=http://sutra-hybrid:8000
      
      # üîí Authentication pass-through
      - SUTRA_AUTH_REQUIRED=true
    depends_on:
      - sutra-api
      - sutra-hybrid
    networks:
      - sutra-internal  # Access to public APIs only
      - sutra-public    # ‚úÖ External access
    restart: unless-stopped

  # ============================================================================
  # BULK INGESTION (OPTIONAL - Admin Only, INTERNAL)
  # ============================================================================
  
  sutra-bulk-ingester:
    build:
      context: .
      dockerfile: ./packages/sutra-bulk-ingester/Dockerfile
    image: sutra-bulk-ingester:latest
    container_name: sutra-bulk-ingester
    # ‚ùå NO EXTERNAL PORTS - Admin-only via Control Center
    expose:
      - "8005"
    volumes:
      - ./datasets:/datasets:ro
      - ingestion-jobs:/jobs
    environment:
      - RUST_LOG=info
      - SUTRA_STORAGE_SERVER=storage-server:50051
      - SUTRA_EMBEDDING_SERVICE_URL=http://embedding-ha:8888
      - SUTRA_GRID_MASTER=grid-master:7001
      - INGESTER_WORKERS=2
      - INGESTER_BATCH_SIZE=100
      
      # üîí AUTHENTICATION
      - SUTRA_AUTH_SECRET=${SUTRA_AUTH_SECRET}
      - SUTRA_SERVICE_TOKEN=${SUTRA_SERVICE_TOKEN}
    depends_on:
      - storage-server
      - grid-master
    networks:
      - sutra-internal  # ‚úÖ Internal only
    restart: unless-stopped
    profiles:
      - bulk-ingester

# ============================================================================
# NETWORKING (Segregated)
# ============================================================================

networks:
  # Internal network - NO external access
  sutra-internal:
    driver: bridge
    internal: true  # üîí CRITICAL: No external routing
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/24
  
  # Public network - External access for user-facing services only
  sutra-public:
    driver: bridge
    internal: false  # ‚úÖ External routing allowed
    ipam:
      driver: default
      config:
        - subnet: 172.21.0.0/24

# ============================================================================
# VOLUMES
# ============================================================================

volumes:
  storage-data:
    driver: local
  grid-event-data:
    driver: local
  agent1-data:
    driver: local
  agent2-data:
    driver: local
  ingestion-jobs:
    driver: local

# ============================================================================
# SECRETS (Docker Secrets - Production)
# ============================================================================

# Uncomment for Docker Swarm mode with secrets
# secrets:
#   auth_secret:
#     external: true
#   service_token:
#     external: true
#   admin_token:
#     external: true
