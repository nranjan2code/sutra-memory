# Sutra AI - Production Grid Deployment
# Unified compose file with all editions and profiles
# Usage: docker-compose -f build/compose/docker-compose.yml --profile simple up

version: '3.8'

networks:
  sutra-network:
    driver: bridge
    
volumes:
  storage-data:
  user-storage-data:
  grid-event-data:
  ingestion-jobs:

x-common-environment: &common-env
  SUTRA_EDITION: ${SUTRA_EDITION:-simple}
  SUTRA_LICENSE_KEY: ${SUTRA_LICENSE_KEY}
  SUTRA_VERSION: ${SUTRA_VERSION:-latest}

services:
  # ============================================================================
  # STORAGE LAYER
  # ============================================================================
  
  storage-server:
    build:
      context: ../..
      dockerfile: build/docker/services/sutra-storage.dockerfile
    image: sutra-storage:${SUTRA_VERSION:-latest}
    container_name: sutra-storage
    ports:
      - "50051:50051"
    volumes:
      - storage-data:/data
    environment:
      <<: *common-env
      STORAGE_PATH: /data
      STORAGE_HOST: 0.0.0.0
      STORAGE_PORT: 50051
      VECTOR_DIMENSION: 768
      SUTRA_EMBEDDING_SERVICE_URL: ${SUTRA_EMBEDDING_URL:-http://embedding-single:8888}
    depends_on:
      embedding-single:
        condition: service_healthy
    networks:
      - sutra-network
    restart: unless-stopped
    profiles: ["simple", "community", "enterprise"]

  user-storage-server:
    build:
      context: ../..  
      dockerfile: build/docker/services/sutra-storage.dockerfile
    image: sutra-storage:${SUTRA_VERSION:-latest}
    container_name: sutra-user-storage
    ports:
      - "50053:50051"
    volumes:
      - user-storage-data:/data
    environment:
      <<: *common-env
      STORAGE_PATH: /data
      STORAGE_HOST: 0.0.0.0
      STORAGE_PORT: 50051
      VECTOR_DIMENSION: 768
    networks:
      - sutra-network
    restart: unless-stopped
    profiles: ["simple", "community", "enterprise"]

  # ============================================================================
  # API LAYER
  # ============================================================================
  
  sutra-api:
    build:
      context: ../..
      dockerfile: build/docker/services/sutra-api.dockerfile
    image: sutra-api:${SUTRA_VERSION:-latest}
    container_name: sutra-api
    ports:
      - "8000:8000"
    environment:
      <<: *common-env
      SUTRA_STORAGE_SERVER: storage-server:50051
      SUTRA_USER_STORAGE_SERVER: user-storage-server:50051
    depends_on:
      storage-server:
        condition: service_healthy
      user-storage-server:
        condition: service_healthy
    networks:
      - sutra-network
    restart: unless-stopped
    profiles: ["simple", "community", "enterprise"]

  sutra-hybrid:
    build:
      context: ../..
      dockerfile: build/docker/services/sutra-hybrid.dockerfile  
    image: sutra-hybrid:${SUTRA_VERSION:-latest}
    container_name: sutra-hybrid
    ports:
      - "8001:8000"
    environment:
      <<: *common-env
      SUTRA_STORAGE_SERVER: storage-server:50051
      SUTRA_USE_SEMANTIC_EMBEDDINGS: true
    depends_on:
      storage-server:
        condition: service_healthy
    networks:
      - sutra-network
    restart: unless-stopped  
    profiles: ["simple", "community", "enterprise"]

  # ============================================================================
  # EMBEDDING SERVICES
  # ============================================================================
  
  embedding-single:
    build:
      context: ../..
      dockerfile: packages/sutra-embedding-service/Dockerfile
    image: sutra-embedding-service:${SUTRA_VERSION:-latest}
    container_name: embedding-single
    ports:
      - "8888:8888"
    environment:
      <<: *common-env
      PORT: 8888
      WORKERS: 1
      EMBEDDING_MODEL: nomic-ai/nomic-embed-text-v1.5
      EMBEDDING_BATCH_SIZE: 64
    networks:
      - sutra-network
    restart: unless-stopped
    profiles: ["simple", "community"]

  # Additional services can be added here following the same pattern...

# ============================================================================
# PROFILES SUMMARY
# ============================================================================
# simple:     7 containers  - FREE edition
# community:  7 containers  - $99/mo edition  
# enterprise: 16 containers - $999/mo edition with HA + Grid