# HAProxy Configuration for Sutra NLG Service HA
# Load balances 3 NLG service replicas with health checks

global
    log stdout format raw local0
    maxconn 2048
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 10s
    timeout client 180s   # Longer for text generation
    timeout server 180s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s
    retries 3
    option redispatch

# Stats interface
listen stats
    bind *:8405
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats auth admin:sutra-nlg-stats

# NLG Service Frontend
frontend nlg_frontend
    bind *:8889
    default_backend nlg_backend
    
    # Request tracking
    http-request set-header X-Request-ID %[uuid()]
    http-response set-header X-Backend-Server %s
    
    # Logging
    capture request header User-Agent len 128
    capture request header Content-Length len 10

# NLG Service Backend
backend nlg_backend
    balance leastconn  # Best for variable-length generation
    
    # Health check configuration
    option httpchk GET /health
    http-check expect status 200
    http-check expect string "healthy"
    
    # Server timeout for generation
    timeout server 180s
    
    # NLG replicas
    server nlg-1 nlg-1:8889 check inter 10s fall 2 rise 2 maxconn 50
    server nlg-2 nlg-2:8889 check inter 10s fall 2 rise 2 maxconn 50
    server nlg-3 nlg-3:8889 check inter 10s fall 2 rise 2 maxconn 50
    
    # HTTP headers
    http-request set-header X-Forwarded-For %[src]
    http-response set-header X-Load-Balancer HAProxy-NLG
