{% extends "base_md3.html" %}

{% block title %}üè† Dashboard - Biological Intelligence{% endblock %}

{% block header_title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
    /* Dashboard-specific styles */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
    }
    
    .hero-card {
        grid-column: 1 / -1;
        background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-tertiary-container));
        color: var(--md-sys-color-on-primary-container);
        position: relative;
        overflow: hidden;
    }
    
    .hero-content {
        position: relative;
        z-index: 2;
    }
    
    .hero-background {
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        opacity: 0.1;
        font-size: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
    }
    
    .consciousness-display {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 16px 0;
    }
    
    .consciousness-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: conic-gradient(from 0deg, var(--bio-consciousness) 0%, var(--bio-consciousness) var(--progress, 0%), var(--md-sys-color-surface-variant) var(--progress, 0%), var(--md-sys-color-surface-variant) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .consciousness-inner {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--md-sys-color-surface);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: var(--md-sys-color-on-surface);
    }
    
    .consciousness-score {
        font-size: 16px;
        font-weight: 700;
        line-height: 1;
    }
    
    .consciousness-label {
        font-size: 8px;
        opacity: 0.7;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metrics-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 16px;
    }
    
    .metric-card {
        text-align: center;
        padding: 16px 12px;
        background: var(--md-sys-color-surface-container-low);
        border-radius: 16px;
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
    }
    
    .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--bio-primary);
        margin-bottom: 4px;
    }
    
    .metric-label {
        font-size: 12px;
        color: var(--md-sys-color-on-surface-variant);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metric-change {
        font-size: 10px;
        font-weight: 500;
        margin-top: 2px;
    }
    
    .metric-change.positive { color: var(--bio-success); }
    .metric-change.negative { color: var(--md-sys-color-error); }
    
    .agents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
    }
    
    .agent-card-mini {
        background: var(--md-sys-color-surface-container-low);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }
    
    .agent-card-mini:hover {
        transform: translateY(-2px);
        background: var(--md-sys-color-surface-container);
    }
    
    .agent-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: var(--md-sys-color-primary-container);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
    }
    
    .agent-icon .material-icons {
        font-size: 18px;
        color: var(--md-sys-color-on-primary-container);
    }
    
    .agent-name {
        font-size: 12px;
        font-weight: 500;
        color: var(--md-sys-color-on-surface);
        margin-bottom: 4px;
    }
    
    .agent-status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        position: absolute;
        top: 8px;
        right: 8px;
    }
    
    .status-active { background: var(--bio-success); }
    .status-inactive { background: var(--md-sys-color-outline); }
    
    .activity-timeline {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .timeline-item {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
    }
    
    .timeline-item:last-child {
        border-bottom: none;
    }
    
    .timeline-time {
        font-size: 12px;
        color: var(--md-sys-color-on-surface-variant);
        min-width: 60px;
    }
    
    .timeline-content {
        flex: 1;
    }
    
    .timeline-message {
        font-size: 14px;
        line-height: 1.4;
        margin-bottom: 2px;
    }
    
    .timeline-details {
        font-size: 12px;
        color: var(--md-sys-color-on-surface-variant);
    }
    
    .activity-type-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-right: 8px;
        background: var(--md-sys-color-primary-container);
        color: var(--md-sys-color-on-primary-container);
    }
    
    .quick-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 16px;
    }
    
    .action-fab {
        width: 56px;
        height: 56px;
        border-radius: 28px;
        background: var(--md-sys-color-secondary-container);
        color: var(--md-sys-color-on-secondary-container);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        position: relative;
    }
    
    .action-fab:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .action-fab .material-icons {
        font-size: 24px;
    }
    
    .fab-label {
        position: absolute;
        bottom: -24px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        text-align: center;
        white-space: nowrap;
        color: var(--md-sys-color-on-surface-variant);
    }
    
    .system-health-indicators {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .health-indicator {
        text-align: center;
        padding: 12px;
        background: var(--md-sys-color-surface-container-low);
        border-radius: 12px;
    }
    
    .health-icon {
        font-size: 32px;
        margin-bottom: 8px;
        display: block;
    }
    
    .health-icon.healthy { color: var(--bio-success); }
    .health-icon.warning { color: var(--bio-warning); }
    .health-icon.error { color: var(--md-sys-color-error); }
    
    .health-label {
        font-size: 12px;
        color: var(--md-sys-color-on-surface-variant);
        margin-bottom: 4px;
    }
    
    .health-value {
        font-size: 14px;
        font-weight: 500;
    }
    
    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .consciousness-display {
            flex-direction: column;
            text-align: center;
        }
        
        .metrics-row {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .quick-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Hero Card - Consciousness Overview -->
    <div class="md3-card hero-card">
        <div class="hero-background">
            <span class="material-icons">psychology</span>
        </div>
        <div class="card-content hero-content">
            <div class="card-title">
                <span class="material-icons">psychology</span>
                Intelligence Status
            </div>
            
            <div class="consciousness-display">
                <div class="consciousness-circle" style="--progress: {{ (status.metrics.consciousness_score / 30 * 100)|int }}%;">
                    <div class="consciousness-inner">
                        <div class="consciousness-score">{{ "%.1f"|format(status.metrics.consciousness_score) }}</div>
                        <div class="consciousness-label">Consciousness</div>
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <h2 style="margin: 0 0 8px 0; font-size: 24px; color: var(--md-sys-color-on-primary-container);">
                        {% if status.service_running %}
                            System Active
                        {% else %}
                            System Inactive
                        {% endif %}
                    </h2>
                    <p style="margin: 0; opacity: 0.8; line-height: 1.4;">
                        {% if status.service_running %}
                            Biological intelligence is operational with {{ formatNumber(status.metrics.total_concepts) }} active concepts.
                            Emergence factor: {{ "%.1f"|format(status.metrics.emergence_factor) }}x
                        {% else %}
                            Click "Activate Intelligence" to start the biological processing system.
                        {% endif %}
                    </p>
                    
                    {% if status.service_running %}
                    <div class="quick-actions">
                        <button class="md3-button button-filled" onclick="navigateTo('intelligence')">
                            <span class="material-icons">chat</span>
                            Query System
                        </button>
                        <button class="md3-button button-outlined" onclick="navigateTo('knowledge')">
                            <span class="material-icons">library_books</span>
                            Manage Data
                        </button>
                        <button class="md3-button button-text" onclick="showSystemControls()">
                            <span class="material-icons">settings</span>
                            Controls
                        </button>
                    </div>
                    {% else %}
                    <div class="quick-actions">
                        <button class="md3-button button-filled" onclick="startBiologicalService()">
                            <span class="material-icons">power_settings_new</span>
                            Start System
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Intelligence Metrics -->
    <div class="md3-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">analytics</span>
                Intelligence Metrics
            </div>
        </div>
        <div class="card-content">
            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-value">{{ formatNumber(status.metrics.total_concepts) }}</div>
                    <div class="metric-label">Concepts</div>
                    <div class="progress-linear">
                        <div class="progress-bar" style="width: {{ min(100, (status.metrics.total_concepts / 1000 * 100)) }}%"></div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value">{{ formatNumber(status.metrics.total_associations) }}</div>
                    <div class="metric-label">Associations</div>
                    <div class="progress-linear">
                        <div class="progress-bar" style="width: {{ min(100, (status.metrics.total_associations / 5000 * 100)) }}%"></div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value">{{ status.metrics.total_dreams }}</div>
                    <div class="metric-label">Dream Cycles</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value">{{ status.metrics.total_training_cycles }}</div>
                    <div class="metric-label">Learning Cycles</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 7-Agent Swarm Status -->
    <div class="md3-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">precision_manufacturing</span>
                Processing Agents
            </div>
            <div class="status-chip {{ 'status-running' if status.service_running else 'status-stopped' }}">
                {{ '7 Active' if status.service_running else '7 Inactive' }}
            </div>
        </div>
        <div class="card-content">
            <div class="agents-grid">
                {% for agent in [
                    ('Molecular', 'Token-level processing', 'analytics'),
                    ('Semantic', 'Meaning extraction', 'translate'), 
                    ('Structural', 'Grammar analysis', 'account_tree'),
                    ('Conceptual', 'Abstract reasoning', 'psychology'),
                    ('Relational', 'Connection mapping', 'hub'),
                    ('Temporal', 'Sequence analysis', 'schedule'),
                    ('Meta', 'Self-monitoring', 'self_improvement')
                ] %}
                <div class="agent-card-mini">
                    <div class="agent-status-indicator {{ 'status-active' if status.service_running else 'status-inactive' }}"></div>
                    <div class="agent-icon">
                        <span class="material-icons">{{ agent[2] }}</span>
                    </div>
                    <div class="agent-name">{{ agent[0] }}</div>
                    <div style="font-size: 10px; color: var(--md-sys-color-on-surface-variant);">{{ agent[1] }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- System Health -->
    <div class="md3-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">health_and_safety</span>
                System Health
            </div>
            <button class="md3-button button-text" onclick="navigateTo('health')">
                <span class="material-icons">arrow_forward</span>
            </button>
        </div>
        <div class="card-content">
            <div class="system-health-indicators">
                <div class="health-indicator">
                    <span class="health-icon material-icons {{ 'healthy' if status.service_running else 'error' }}">
                        {{ 'check_circle' if status.service_running else 'error' }}
                    </span>
                    <div class="health-label">Service</div>
                    <div class="health-value">{{ 'Running' if status.service_running else 'Stopped' }}</div>
                </div>
                
                <div class="health-indicator">
                    <span class="health-icon material-icons healthy">memory</span>
                    <div class="health-label">Runtime</div>
                    <div class="health-value">{{ status.process_info.pid }}</div>
                </div>
                
                <div class="health-indicator">
                    <span class="health-icon material-icons healthy">storage</span>
                    <div class="health-label">Mode</div>
                    <div class="health-value">{{ status.mode.title() }}</div>
                </div>
                
                {% if status.pi_mode and status.hardware_info %}
                <div class="health-indicator">
                    <span class="health-icon material-icons {{ 'error' if status.hardware_info.cpu_temp > 75 else 'warning' if status.hardware_info.cpu_temp > 65 else 'healthy' }}">
                        device_thermostat
                    </span>
                    <div class="health-label">CPU Temp</div>
                    <div class="health-value">{{ "%.1f"|format(status.hardware_info.cpu_temp) }}¬∞C</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="md3-card" style="grid-column: 1 / -1;">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">notifications</span>
                System Events
            </div>
            <div class="status-chip {{ 'status-running' if status.service_running else 'status-stopped' }}" id="live-indicator">
                <span class="material-icons" style="font-size: 12px; animation: pulse 2s infinite;">circle</span>
                {{ 'Live' if status.service_running else 'Offline' }}
            </div>
        </div>
        <div class="card-content">
            <div class="activity-timeline" id="activity-timeline">
                <!-- Activity items will be populated via WebSocket -->
                {% if status.service_running %}
                <div class="timeline-item">
                    <div class="timeline-time">{{ status.timestamp[11:16] }}</div>
                    <div class="timeline-content">
                        <div class="timeline-message">System initialized successfully</div>
                        <div class="timeline-details">Consciousness level: {{ "%.2f"|format(status.metrics.consciousness_score) }}</div>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-time">{{ status.timestamp[11:16] }}</div>
                    <div class="timeline-content">
                        <div class="timeline-message">Knowledge base loaded</div>
                        <div class="timeline-details">{{ formatNumber(status.metrics.total_concepts) }} concepts, {{ formatNumber(status.metrics.total_associations) }} associations</div>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-time">{{ status.timestamp[11:16] }}</div>
                    <div class="timeline-content">
                        <div class="timeline-message">Processing agents activated</div>
                        <div class="timeline-details">Emergence factor: {{ "%.1f"|format(status.metrics.emergence_factor) }}x</div>
                    </div>
                </div>
                {% else %}
                <div class="timeline-item">
                    <div class="timeline-time">{{ status.timestamp[11:16] }}</div>
                    <div class="timeline-content">
                        <div class="timeline-message">System offline</div>
                        <div class="timeline-details">Use the controls above to start the system</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block primary_action %}
// Dashboard primary action: Start intelligence or open chat
if ({{ 'true' if status.service_running else 'false' }}) {
    navigateTo('intelligence');
} else {
    startBiologicalService();
}
{% endblock %}

{% block websocket_handler %}
if (data.type === 'status_update') {
    // Update metrics in real-time
    updateDashboardMetrics(data.data);
} else if (data.type === 'service_status' || data.type === 'knowledge_fed' || 
          data.type === 'query_completed' || data.type === 'curriculum_feeding') {
    addActivityItem(data);
}
{% endblock %}

{% block extra_scripts %}
<script>
    let activityCount = 0;
    
    // Dashboard-specific functions
    function updateDashboardMetrics(status) {
        // Update consciousness circle
        const consciousnessCircle = document.querySelector('.consciousness-circle');
        if (consciousnessCircle && status.metrics) {
            const progress = Math.min(100, (status.metrics.consciousness_score / 30) * 100);
            consciousnessCircle.style.setProperty('--progress', progress + '%');
            
            const scoreElement = consciousnessCircle.querySelector('.consciousness-score');
            if (scoreElement) {
                scoreElement.textContent = status.metrics.consciousness_score.toFixed(1);
            }
        }
        
        // Update metric values
        updateMetricValue('.metric-card:nth-child(1) .metric-value', formatNumber(status.metrics.total_concepts || 0));
        updateMetricValue('.metric-card:nth-child(2) .metric-value', formatNumber(status.metrics.total_associations || 0));
        updateMetricValue('.metric-card:nth-child(3) .metric-value', status.metrics.total_dreams || 0);
        updateMetricValue('.metric-card:nth-child(4) .metric-value', status.metrics.total_training_cycles || 0);
        
        // Update progress bars
        updateProgressBar('.metric-card:nth-child(1) .progress-bar', Math.min(100, (status.metrics.total_concepts || 0) / 1000 * 100));
        updateProgressBar('.metric-card:nth-child(2) .progress-bar', Math.min(100, (status.metrics.total_associations || 0) / 5000 * 100));
    }
    
    function updateMetricValue(selector, value) {
        const element = document.querySelector(selector);
        if (element) {
            element.textContent = value;
        }
    }
    
    function updateProgressBar(selector, percentage) {
        const element = document.querySelector(selector);
        if (element) {
            element.style.width = percentage + '%';
        }
    }
    
    function addActivityItem(data) {
        const timeline = document.getElementById('activity-timeline');
        if (!timeline) return;
        
        const time = new Date().toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const item = document.createElement('div');
        item.className = 'timeline-item fade-in';
        
        let icon, message, details;
        
        let activityType, message, details;
        switch(data.type) {
            case 'service_status':
                activityType = data.success ? 'SUCCESS' : 'ERROR';
                message = data.message;
                details = 'Service management';
                break;
            case 'knowledge_fed':
                activityType = 'DATA';
                message = 'Knowledge processed';
                details = data.knowledge ? data.knowledge.substring(0, 50) + '...' : 'New content added';
                break;
            case 'query_completed':
                activityType = 'QUERY';
                message = 'Query processed';
                details = data.question ? data.question.substring(0, 50) + '...' : 'Intelligence response generated';
                break;
            case 'curriculum_feeding':
                activityType = 'TRAINING';
                message = data.message;
                details = `Mode: ${data.mode}`;
                break;
            default:
                activityType = 'INFO';
                message = data.message || 'System event';
                details = 'General activity';
        }
        
        item.innerHTML = `
            <div class="timeline-time">${time}</div>
            <div class="timeline-content">
                <div class="timeline-message">
                    <span class="activity-type-badge">${activityType}</span>
                    ${message}
                </div>
                <div class="timeline-details">${details}</div>
            </div>
        `;
        
        // Insert at the beginning
        timeline.insertBefore(item, timeline.firstChild);
        
        // Limit to 10 items
        if (timeline.children.length > 10) {
            timeline.removeChild(timeline.lastChild);
        }
        
        activityCount++;
    }
    
    function startBiologicalService() {
        const mode = '{{ status.mode }}' || 'general';
        
        const formData = new FormData();
        formData.append('mode', mode);
        
        fetch('/api/service/start', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showSnackbar('System activated successfully', 'VIEW');
                setTimeout(() => location.reload(), 2000);
            } else {
                showSnackbar('Failed to start system: ' + (result.error || result.message), 'RETRY');
            }
        })
        .catch(error => {
            showSnackbar('System error: ' + error.message, 'RETRY');
        });
    }
    
    function showSystemControls() {
        // Show system controls dialog/modal
        const controls = [
            { icon: 'stop', label: 'Stop Service', action: 'stopService()' },
            { icon: 'refresh', label: 'Restart Service', action: 'restartService()' },
            { icon: 'swap_horiz', label: 'Switch Mode', action: 'switchMode()' },
            { icon: 'school', label: 'Feed Curriculum', action: 'feedCurriculum()' }
        ];
        
        let controlsHtml = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">';
        controls.forEach(control => {
            controlsHtml += `
                <button class="md3-button button-outlined" onclick="${control.action}" style="justify-content: flex-start;">
                    <span class="material-icons">${control.icon}</span>
                    ${control.label}
                </button>
            `;
        });
        controlsHtml += '</div>';
        
        showSnackbar('System Controls: ' + controlsHtml, null);
    }
    
    async function stopService() {
        try {
            const response = await fetch('/api/service/stop', { method: 'POST' });
            const result = await response.json();
            showSnackbar(result.message || 'Service management action completed');
        } catch (error) {
            showSnackbar('Error: ' + error.message);
        }
    }
    
    async function restartService() {
        showSnackbar('Restarting system...');
        await stopService();
        setTimeout(() => startBiologicalService(), 2000);
    }
    
    async function switchMode() {
        const currentMode = '{{ status.mode }}';
        const newMode = currentMode === 'english' ? 'general' : 'english';
        
        const formData = new FormData();
        formData.append('new_mode', newMode);
        
        try {
            const response = await fetch('/api/mode/switch', { method: 'POST', body: formData });
            const result = await response.json();
            
            if (result.success) {
                showSnackbar(`Switched to ${newMode} mode`, 'RELOAD');
                setTimeout(() => location.reload(), 1500);
            }
        } catch (error) {
            showSnackbar('Error switching mode: ' + error.message);
        }
    }
    
    async function feedCurriculum() {
        try {
            const response = await fetch('/api/curriculum/feed', { method: 'POST' });
            const result = await response.json();
            showSnackbar(result.message || 'Curriculum feeding initiated', 'VIEW');
        } catch (error) {
            showSnackbar('Error: ' + error.message);
        }
    }
    
    // Utility function for number formatting
    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        // Add initial system status
        {% if status.service_running %}
        setTimeout(() => {
            addActivityItem({
                type: 'system',
                message: 'Dashboard ready',
                success: true
            });
        }, 1000);
        {% endif %}
    });
</script>
{% endblock %}