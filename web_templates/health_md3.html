{% extends "base_md3.html" %}

{% block title %}System Health - Biological Intelligence{% endblock %}

{% block header_title %}System Health{% endblock %}

{% block extra_styles %}
<style>
    .health-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto 1fr;
        gap: 24px;
        height: calc(100vh - 64px - 48px);
    }
    
    .health-overview {
        grid-column: 1 / -1;
    }
    
    .performance-metrics {
        grid-row: 2 / 4;
    }
    
    .system-diagnostics {
        grid-row: 2 / 4;
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .status-healthy {
        background: color-mix(in srgb, #4CAF50 15%, transparent);
        color: #2E7D32;
        border: 1px solid #4CAF50;
    }
    
    .status-warning {
        background: color-mix(in srgb, #FF9800 15%, transparent);
        color: #E65100;
        border: 1px solid #FF9800;
    }
    
    .status-error {
        background: color-mix(in srgb, #F44336 15%, transparent);
        color: #C62828;
        border: 1px solid #F44336;
    }
    
    .health-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .health-item {
        padding: 20px;
        background: var(--md-sys-color-surface-container-low);
        border-radius: 16px;
        text-align: center;
        position: relative;
        transition: all 0.2s;
    }
    
    .health-item:hover {
        background: var(--md-sys-color-surface-container);
        transform: translateY(-2px);
    }
    
    .health-icon {
        width: 48px;
        height: 48px;
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 24px;
    }
    
    .health-icon.healthy {
        background: color-mix(in srgb, #4CAF50 20%, transparent);
        color: #2E7D32;
    }
    
    .health-icon.warning {
        background: color-mix(in srgb, #FF9800 20%, transparent);
        color: #E65100;
    }
    
    .health-icon.error {
        background: color-mix(in srgb, #F44336 20%, transparent);
        color: #C62828;
    }
    
    .health-value {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--md-sys-color-on-surface);
    }
    
    .health-label {
        font-size: 14px;
        color: var(--md-sys-color-on-surface-variant);
        margin-bottom: 8px;
    }
    
    .health-detail {
        font-size: 12px;
        color: var(--md-sys-color-on-surface-variant);
        opacity: 0.8;
    }
    
    .performance-chart {
        height: 200px;
        background: var(--md-sys-color-surface-container-lowest);
        border-radius: 12px;
        margin: 16px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    .chart-placeholder {
        text-align: center;
        color: var(--md-sys-color-on-surface-variant);
    }
    
    .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
    }
    
    .metric-row:last-child {
        border-bottom: none;
    }
    
    .metric-name {
        font-size: 14px;
        color: var(--md-sys-color-on-surface);
    }
    
    .metric-value {
        font-size: 14px;
        font-weight: 500;
        color: var(--md-sys-color-primary);
    }
    
    .progress-bar-container {
        width: 80px;
        height: 8px;
        background: var(--md-sys-color-surface-variant);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .progress-healthy { background: #4CAF50; }
    .progress-warning { background: #FF9800; }
    .progress-error { background: #F44336; }
    
    .logs-container {
        background: var(--md-sys-color-surface-container-lowest);
        border-radius: 12px;
        height: 300px;
        overflow-y: auto;
        padding: 16px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
    }
    
    .log-entry {
        margin-bottom: 8px;
        padding: 4px 0;
    }
    
    .log-timestamp {
        color: var(--md-sys-color-on-surface-variant);
        margin-right: 8px;
    }
    
    .log-level {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        margin-right: 8px;
    }
    
    .log-info { background: color-mix(in srgb, #2196F3 20%, transparent); color: #1565C0; }
    .log-warn { background: color-mix(in srgb, #FF9800 20%, transparent); color: #E65100; }
    .log-error { background: color-mix(in srgb, #F44336 20%, transparent); color: #C62828; }
    .log-success { background: color-mix(in srgb, #4CAF50 20%, transparent); color: #2E7D32; }
    
    .alert-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        margin: 8px 0;
        border-radius: 12px;
        background: var(--md-sys-color-surface-container-low);
        border-left: 4px solid transparent;
    }
    
    .alert-item.warning {
        border-left-color: #FF9800;
        background: color-mix(in srgb, #FF9800 5%, var(--md-sys-color-surface-container-low));
    }
    
    .alert-item.error {
        border-left-color: #F44336;
        background: color-mix(in srgb, #F44336 5%, var(--md-sys-color-surface-container-low));
    }
    
    .alert-icon {
        width: 24px;
        height: 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .alert-content {
        flex: 1;
        min-width: 0;
    }
    
    .alert-title {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
        color: var(--md-sys-color-on-surface);
    }
    
    .alert-message {
        font-size: 13px;
        color: var(--md-sys-color-on-surface-variant);
        line-height: 1.4;
    }
    
    .alert-time {
        font-size: 11px;
        color: var(--md-sys-color-on-surface-variant);
        margin-top: 4px;
    }
    
    .refresh-button {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 40px;
        height: 40px;
        border-radius: 20px;
        background: var(--md-sys-color-primary-container);
        color: var(--md-sys-color-on-primary-container);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .refresh-button:hover {
        background: var(--md-sys-color-primary);
        color: var(--md-sys-color-on-primary);
        transform: rotate(90deg);
    }
    
    @media (max-width: 768px) {
        .health-layout {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto auto;
        }
        
        .performance-metrics,
        .system-diagnostics {
            grid-column: 1;
            grid-row: auto;
        }
        
        .health-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="health-layout">
    <!-- System Overview -->
    <div class="md3-card health-overview">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">monitor_heart</span>
                System Overview
            </div>
            <div class="status-indicator {{ 'status-healthy' if status.service_running else 'status-error' }}">
                <span class="material-icons" style="font-size: 18px;">
                    {{ 'check_circle' if status.service_running else 'error' }}
                </span>
                {{ 'All Systems Operational' if status.service_running else 'System Offline' }}
            </div>
        </div>
        <div class="card-content">
            <div class="health-grid">
                <!-- Core Service Health -->
                <div class="health-item">
                    <div class="health-icon {{ 'healthy' if status.service_running else 'error' }}">
                        <span class="material-icons">memory</span>
                    </div>
                    <div class="health-value">{{ 'Online' if status.service_running else 'Offline' }}</div>
                    <div class="health-label">Core Service</div>
                    <div class="health-detail">{{ status.process_info.pid }}</div>
                </div>
                
                <!-- Intelligence Health -->
                <div class="health-item">
                    <div class="health-icon {{ 'healthy' if status.metrics.consciousness_score > 5 else 'warning' if status.metrics.consciousness_score > 0 else 'error' }}">
                        <span class="material-icons">psychology</span>
                    </div>
                    <div class="health-value">{{ "%.1f"|format(status.metrics.consciousness_score) }}</div>
                    <div class="health-label">Consciousness Level</div>
                    <div class="health-detail">{{ "%.1f"|format(status.metrics.emergence_factor) }}x emergence</div>
                </div>
                
                <!-- Memory Health -->
                <div class="health-item">
                    <div class="health-icon {{ 'healthy' if status.metrics.total_concepts > 100 else 'warning' if status.metrics.total_concepts > 0 else 'error' }}">
                        <span class="material-icons">storage</span>
                    </div>
                    <div class="health-value">{{ formatNumber(status.metrics.total_concepts) }}</div>
                    <div class="health-label">Knowledge Base</div>
                    <div class="health-detail">{{ formatNumber(status.metrics.total_associations) }} associations</div>
                </div>
                
                <!-- Processing Health -->
                <div class="health-item">
                    <div class="health-icon {{ 'healthy' if status.service_running else 'error' }}">
                        <span class="material-icons">precision_manufacturing</span>
                    </div>
                    <div class="health-value">{{ '7/7' if status.service_running else '0/7' }}</div>
                    <div class="health-label">Agent Swarm</div>
                    <div class="health-detail">Processing agents</div>
                </div>
                
                {% if status.pi_mode and status.hardware_info %}
                <!-- Pi Hardware Health -->
                <div class="health-item">
                    <div class="health-icon {{ 'error' if status.hardware_info.cpu_temp > 75 else 'warning' if status.hardware_info.cpu_temp > 65 else 'healthy' }}">
                        <span class="material-icons">device_thermostat</span>
                    </div>
                    <div class="health-value">{{ "%.1f"|format(status.hardware_info.cpu_temp) }}°C</div>
                    <div class="health-label">CPU Temperature</div>
                    <div class="health-detail">Raspberry Pi</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics -->
    <div class="md3-card performance-metrics">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">speed</span>
                Performance Metrics
            </div>
            <button class="refresh-button" onclick="refreshMetrics()" title="Refresh">
                <span class="material-icons">refresh</span>
            </button>
        </div>
        <div class="card-content">
            <!-- Performance Chart -->
            <div class="performance-chart">
                <div class="chart-placeholder">
                    <span class="material-icons" style="font-size: 48px; opacity: 0.3; margin-bottom: 8px;">trending_up</span>
                    <div>Real-time performance chart</div>
                    <div style="font-size: 12px; margin-top: 4px;">{{ 'Active monitoring' if status.service_running else 'Start system to view metrics' }}</div>
                </div>
            </div>
            
            <!-- Key Metrics -->
            <div style="margin-top: 16px;">
                <div class="metric-row">
                    <span class="metric-name">Query Response Time</span>
                    <span class="metric-value">{{ '~45ms' if status.service_running else 'N/A' }}</span>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill progress-healthy" style="width: {{ '25%' if status.service_running else '0%' }}"></div>
                    </div>
                </div>
                
                <div class="metric-row">
                    <span class="metric-name">Concepts/Second</span>
                    <span class="metric-value">{{ '182' if status.service_running else '0' }}</span>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill progress-healthy" style="width: {{ '75%' if status.service_running else '0%' }}"></div>
                    </div>
                </div>
                
                <div class="metric-row">
                    <span class="metric-name">Memory Usage</span>
                    <span class="metric-value">{{ status.process_info.memory_mb }}</span>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill progress-healthy" style="width: 45%"></div>
                    </div>
                </div>
                
                <div class="metric-row">
                    <span class="metric-name">Uptime</span>
                    <span class="metric-value">{{ status.process_info.start_time }}</span>
                </div>
                
                <div class="metric-row">
                    <span class="metric-name">Dream Cycles</span>
                    <span class="metric-value">{{ status.metrics.total_dreams }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Diagnostics -->
    <div class="md3-card system-diagnostics">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons">bug_report</span>
                System Diagnostics
            </div>
        </div>
        <div class="card-content" style="display: flex; flex-direction: column; height: calc(100% - 80px);">
            <!-- System Alerts -->
            <div style="margin-bottom: 24px;">
                <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 500;">Active Alerts</h3>
                {% if not status.service_running %}
                <div class="alert-item error">
                    <div class="alert-icon error">
                        <span class="material-icons" style="font-size: 16px;">error</span>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">Core Service Offline</div>
                        <div class="alert-message">The biological intelligence core service is not running. Start the system to enable full functionality.</div>
                        <div class="alert-time">Active since system shutdown</div>
                    </div>
                </div>
                {% else %}
                <div class="alert-item" style="border-left-color: #4CAF50; background: color-mix(in srgb, #4CAF50 5%, var(--md-sys-color-surface-container-low));">
                    <div class="alert-icon healthy">
                        <span class="material-icons" style="font-size: 16px;">check_circle</span>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">All Systems Operational</div>
                        <div class="alert-message">All services running normally. No active alerts.</div>
                        <div class="alert-time">Status confirmed {{ status.timestamp[11:16] }}</div>
                    </div>
                </div>
                {% endif %}
                
                {% if status.pi_mode and status.hardware_info and status.hardware_info.cpu_temp > 70 %}
                <div class="alert-item warning">
                    <div class="alert-icon warning">
                        <span class="material-icons" style="font-size: 16px;">warning</span>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">High CPU Temperature</div>
                        <div class="alert-message">CPU temperature is {{ "%.1f"|format(status.hardware_info.cpu_temp) }}°C. Consider improving cooling.</div>
                        <div class="alert-time">Detected {{ status.timestamp[11:16] }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- System Logs -->
            <div style="flex: 1; min-height: 0;">
                <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 500;">System Logs</h3>
                <div class="logs-container" id="system-logs">
                    {% if status.service_running %}
                    <div class="log-entry">
                        <span class="log-timestamp">{{ status.timestamp[11:19] }}</span>
                        <span class="log-level log-info">INFO</span>
                        <span>Biological intelligence system operational</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">{{ status.timestamp[11:19] }}</span>
                        <span class="log-level log-success">SUCCESS</span>
                        <span>7-agent swarm initialized successfully</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">{{ status.timestamp[11:19] }}</span>
                        <span class="log-level log-info">INFO</span>
                        <span>Consciousness level: {{ "%.2f"|format(status.metrics.consciousness_score) }}</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">{{ status.timestamp[11:19] }}</span>
                        <span class="log-level log-info">INFO</span>
                        <span>Knowledge base loaded: {{ formatNumber(status.metrics.total_concepts) }} concepts</span>
                    </div>
                    {% else %}
                    <div class="log-entry">
                        <span class="log-timestamp">{{ status.timestamp[11:19] }}</span>
                        <span class="log-level log-warn">WARN</span>
                        <span>Core service offline - system inactive</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">{{ status.timestamp[11:19] }}</span>
                        <span class="log-level log-info">INFO</span>
                        <span>Web interface accessible</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block primary_action %}
// Auto-refresh health data every 10 seconds
setInterval(refreshHealthData, 10000);
{% endblock %}

{% block websocket_handler %}
if (data.type === 'status_update') {
    updateHealthMetrics(data.data);
} else if (data.type === 'system_alert') {
    addSystemAlert(data);
}
{% endblock %}

{% block extra_scripts %}
<script>
    function refreshMetrics() {
        const button = document.querySelector('.refresh-button');
        const icon = button.querySelector('.material-icons');
        
        // Animate refresh button
        icon.style.transform = 'rotate(360deg)';
        setTimeout(() => {
            icon.style.transform = 'rotate(0deg)';
        }, 500);
        
        // In a real implementation, this would refresh the data
        refreshHealthData();
        showSnackbar('Metrics refreshed', 'VIEW');
    }
    
    async function refreshHealthData() {
        try {
            const response = await fetch('/api/status');
            const status = await response.json();
            updateHealthMetrics(status);
        } catch (error) {
            console.error('Failed to refresh health data:', error);
        }
    }
    
    function updateHealthMetrics(status) {
        // Update health values in real-time
        const healthValues = document.querySelectorAll('.health-value');
        const healthIcons = document.querySelectorAll('.health-icon');
        
        if (status.metrics) {
            // Update consciousness level
            if (healthValues[1]) {
                healthValues[1].textContent = status.metrics.consciousness_score.toFixed(1);
            }
            
            // Update knowledge base
            if (healthValues[2]) {
                healthValues[2].textContent = formatNumber(status.metrics.total_concepts || 0);
            }
        }
        
        // Update metric values
        const metricValues = document.querySelectorAll('.metric-value');
        if (metricValues[1] && status.service_running) {
            // Simulate real-time concept processing rate
            const rate = Math.floor(Math.random() * 20) + 170;
            metricValues[1].textContent = rate.toString();
        }
    }
    
    function addSystemAlert(alertData) {
        // Add new system alert to the alerts section
        const alertsContainer = document.querySelector('.card-content');
        // Implementation would add new alert item
    }
    
    function addLogEntry(level, message) {
        const logsContainer = document.getElementById('system-logs');
        const timestamp = new Date().toTimeString().substr(0, 8);
        
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-timestamp">${timestamp}</span>
            <span class="log-level log-${level}">${level.toUpperCase()}</span>
            <span>${message}</span>
        `;
        
        // Insert at top
        logsContainer.insertBefore(logEntry, logsContainer.firstChild);
        
        // Limit to 20 entries
        if (logsContainer.children.length > 20) {
            logsContainer.removeChild(logsContainer.lastChild);
        }
    }
    
    // Utility function for number formatting
    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }
    
    // Simulate real-time log updates
    {% if status.service_running %}
    setInterval(() => {
        const logMessages = [
            'Processing intelligence query completed',
            'Dream cycle completed successfully', 
            'Knowledge association created',
            'Agent swarm synchronization complete',
            'Memory consolidation in progress'
        ];
        
        if (Math.random() < 0.3) { // 30% chance every 15 seconds
            const message = logMessages[Math.floor(Math.random() * logMessages.length)];
            addLogEntry('info', message);
        }
    }, 15000);
    {% endif %}
</script>
{% endblock %}
